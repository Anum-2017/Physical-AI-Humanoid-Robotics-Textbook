// Validation Report Generator for Physical AI & Humanoid Robotics textbook
// Generates human-readable reports for content reviewers

const fs = require('fs');
const path = require('path');

class ReportGenerator {
  constructor() {
    this.reportTemplate = this.loadReportTemplate();
  }

  // Load the report template
  loadReportTemplate() {
    return `# Chapter Validation Report

## Summary
- **File**: {fileName}
- **Validation Time**: {validationTime}
- **Overall Status**: {overallStatus}
- **Total Errors**: {totalErrors}

## Compliance Status
- **Structure Compliance**: {structureStatus}
- **Constitution Compliance**: {constitutionStatus}
- **MDX Compliance**: {mdxStatus}
- **Robotics Standards Compliance**: {roboticsStatus}
- **Schema Compliance**: {schemaStatus}
- **Inter-Module Coherence Compliance**: {coherenceStatus}

## Errors
{errorList}

## Recommendations
{recommendations}

## Compliance Details
This chapter was validated against the Physical AI & Humanoid Robotics constitution requirements:
1. Embodied Intelligence First
2. Simulation-to-Reality Progressive Learning
3. Multi-Platform Technical Standards
4. Modular & Maintainable Content
5. Academic Rigor with Practical Application
6. Progressive Learning Structure
7. Inter-Module Coherence

Report generated by Physical AI & Humanoid Robotics validation framework.
`;
  }

  // Generate a validation report from the validation result
  generateReport(validationResult, fileName = 'Unknown') {
    const {
      timestamp,
      isValid,
      errors,
      compliance
    } = validationResult;

    // Format the status values
    const overallStatus = isValid ? 'PASSED' : 'FAILED';
    const structureStatus = compliance.structure ? 'PASSED' : 'FAILED';
    const constitutionStatus = compliance.constitution ? 'PASSED' : 'FAILED';
    const mdxStatus = compliance.mdx ? 'PASSED' : 'FAILED';
    const roboticsStatus = compliance.robotics ? 'PASSED' : 'FAILED';
    const schemaStatus = compliance.schema ? 'PASSED' : 'FAILED';
    const coherenceStatus = compliance.coherence ? 'PASSED' : 'FAILED';

    // Format errors list
    const errorList = errors.length > 0
      ? errors.map((error, index) => `${index + 1}. ${error}`).join('\n')
      : 'No errors found';

    // Generate recommendations
    const recommendations = this.generateRecommendations(errors, compliance);

    // Replace template placeholders
    let report = this.reportTemplate;
    report = report.replace('{fileName}', fileName);
    report = report.replace('{validationTime}', timestamp);
    report = report.replace('{overallStatus}', overallStatus);
    report = report.replace('{totalErrors}', errors.length);
    report = report.replace('{structureStatus}', structureStatus);
    report = report.replace('{constitutionStatus}', constitutionStatus);
    report = report.replace('{mdxStatus}', mdxStatus);
    report = report.replace('{roboticsStatus}', roboticsStatus);
    report = report.replace('{schemaStatus}', schemaStatus);
    report = report.replace('{coherenceStatus}', coherenceStatus);
    report = report.replace('{errorList}', errorList);
    report = report.replace('{recommendations}', recommendations);

    return report;
  }

  // Generate recommendations based on errors and compliance status
  generateRecommendations(errors, compliance) {
    const recommendations = [];

    if (!compliance.structure) {
      recommendations.push(
        '• Review the required sections: Introduction, Core Concepts, Technical Deep Dive, ' +
        'Hands-On Walkthrough, Simulation vs. Real-World, Summary, and Glossary/Key Terms'
      );
    }

    if (!compliance.constitution) {
      recommendations.push(
        '• Ensure all content aligns with Physical AI constitution requirements, ' +
        'especially embodied intelligence and simulation-to-reality principles'
      );
    }

    if (!compliance.mdx) {
      recommendations.push(
        '• Check MDX syntax and ensure proper frontmatter is included'
      );
    }

    if (!compliance.robotics) {
      recommendations.push(
        '• Add references to robotics standards (ROS 2, Gazebo, Isaac Sim, etc.) ' +
        'as required by Physical AI constitution'
      );
    }

    if (!compliance.schema) {
      recommendations.push(
        '• Review and update content to match the chapter schema requirements'
      );
    }

    if (!compliance.coherence) {
      recommendations.push(
        '• Ensure content maintains consistency with inter-module coherence requirements, ' +
        'particularly regarding the ROS → Gazebo → Isaac → VLA stack terminology'
      );
    }

    if (errors.length > 0) {
      recommendations.push(
        '• Address all validation errors listed above before proceeding'
      );
    }

    if (recommendations.length === 0) {
      recommendations.push(
        '• No specific recommendations - chapter is compliant with all requirements'
      );
    }

    return recommendations.join('\n');
  }

  // Save report to file
  saveReport(report, outputPath) {
    fs.writeFileSync(outputPath, report);
    console.log(`Validation report saved to: ${outputPath}`);
  }

  // Generate and save report directly
  generateAndSaveReport(validationResult, fileName, outputPath) {
    const report = this.generateReport(validationResult, fileName);
    this.saveReport(report, outputPath);
    return report;
  }
}

module.exports = ReportGenerator;